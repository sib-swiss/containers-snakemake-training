
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../5_reproducibility_snakemake/">
      
      
        <link rel="next" href="../7_debugging_snakemake/">
      
      
      <link rel="icon" href="../../assets/images/SIB_logo.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.35">
    
    
      
        <title>Running Snakemake in an HPC environment - Reproducible and Scalable Research with Snakemake</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.35f28582.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  <!-- Matomo -->
<script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="https://matomo.sib.swiss/";
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', '220']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
  </script>
  <!-- End Matomo Code -->
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#learning-outcomes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
  You're not viewing the latest version.
  <a href="../../.."> 
    <strong>Click here to go to latest.</strong>
  </a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Reproducible and Scalable Research with Snakemake" class="md-header__button md-logo" aria-label="Reproducible and Scalable Research with Snakemake" data-md-component="logo">
      
  <img src="../../assets/images/SIB_logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Reproducible and Scalable Research with Snakemake
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Running Snakemake in an HPC environment
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/sib-swiss/containers-snakemake-training" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    sib-swiss/containers-snakemake-training
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Reproducible and Scalable Research with Snakemake" class="md-nav__button md-logo" aria-label="Reproducible and Scalable Research with Snakemake" data-md-component="logo">
      
  <img src="../../assets/images/SIB_logo.svg" alt="logo">

    </a>
    Reproducible and Scalable Research with Snakemake
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/sib-swiss/containers-snakemake-training" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    sib-swiss/containers-snakemake-training
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../precourse/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Precourse preparations
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../course_schedule/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Course schedule
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Course material
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Course material
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1_guidelines/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    General guidelines
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2_introduction_snakemake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction to Snakemake
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3_generalising_snakemake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Making a more general-purpose Snakemake workflow
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4_optimising_snakemake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Decorating and optimising a Snakemake workflow
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5_reproducibility_snakemake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Being reproducible with Snakemake
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Running Snakemake in an HPC environment
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Running Snakemake in an HPC environment
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-outcomes" class="md-nav__link">
    <span class="md-ellipsis">
      Learning outcomes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#material" class="md-nav__link">
    <span class="md-ellipsis">
      Material
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workflow-from-previous-session" class="md-nav__link">
    <span class="md-ellipsis">
      Workflow from previous session
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercises" class="md-nav__link">
    <span class="md-ellipsis">
      Exercises
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exercises">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#benchmarking-a-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Benchmarking a workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#controlling-memory-usage-and-runtime" class="md-nav__link">
    <span class="md-ellipsis">
      Controlling memory usage and runtime
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setting-up-snakemake-to-send-jobs-via-the-slurm-job-scheduler" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up Snakemake to send jobs via the SLURM job scheduler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setting up Snakemake to send jobs via the SLURM job scheduler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-configuration-profiles" class="md-nav__link">
    <span class="md-ellipsis">
      Using configuration profiles
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-rule-specific-resources-to-the-job-scheduler" class="md-nav__link">
    <span class="md-ellipsis">
      Passing rule-specific resources to the job scheduler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adapting-the-workflow-to-the-available-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Adapting the workflow to the available resources
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-exercise" class="md-nav__link">
    <span class="md-ellipsis">
      Final exercise
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../7_debugging_snakemake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Additional concepts and workflow design/debugging
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-outcomes" class="md-nav__link">
    <span class="md-ellipsis">
      Learning outcomes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#material" class="md-nav__link">
    <span class="md-ellipsis">
      Material
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workflow-from-previous-session" class="md-nav__link">
    <span class="md-ellipsis">
      Workflow from previous session
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercises" class="md-nav__link">
    <span class="md-ellipsis">
      Exercises
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exercises">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#benchmarking-a-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Benchmarking a workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#controlling-memory-usage-and-runtime" class="md-nav__link">
    <span class="md-ellipsis">
      Controlling memory usage and runtime
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setting-up-snakemake-to-send-jobs-via-the-slurm-job-scheduler" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up Snakemake to send jobs via the SLURM job scheduler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setting up Snakemake to send jobs via the SLURM job scheduler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-configuration-profiles" class="md-nav__link">
    <span class="md-ellipsis">
      Using configuration profiles
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-rule-specific-resources-to-the-job-scheduler" class="md-nav__link">
    <span class="md-ellipsis">
      Passing rule-specific resources to the job scheduler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adapting-the-workflow-to-the-available-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Adapting the workflow to the available resources
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-exercise" class="md-nav__link">
    <span class="md-ellipsis">
      Final exercise
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Running Snakemake in an HPC environment</h1>

<h2 id="learning-outcomes">Learning outcomes</h2>
<p><strong>After having completed this chapter you will be able to:</strong></p>
<ul>
<li>Understand resource usage in each rule with the <code>benchmark</code> directive</li>
<li>Optimise resource usage in a workflow with the <code>resources</code> directive</li>
<li>Run a Snakemake workflow in an SLURM-based HPC environment</li>
<li>Set up workflow-specific configuration profiles</li>
</ul>
<h2 id="material">Material</h2>
<p><a class="md-button" href="../../assets/pdf/6_hpc_snakemake.pdf"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M0 64C0 28.7 28.7 0 64 0h160v128c0 17.7 14.3 32 32 32h128v144H176c-35.3 0-64 28.7-64 64v144H64c-35.3 0-64-28.7-64-64zm384 64H256V0zM176 352h32c30.9 0 56 25.1 56 56s-25.1 56-56 56h-16v32c0 8.8-7.2 16-16 16s-16-7.2-16-16V368c0-8.8 7.2-16 16-16m32 80c13.3 0 24-10.7 24-24s-10.7-24-24-24h-16v48zm96-80h32c26.5 0 48 21.5 48 48v64c0 26.5-21.5 48-48 48h-32c-8.8 0-16-7.2-16-16V368c0-8.8 7.2-16 16-16m32 128c8.8 0 16-7.2 16-16v-64c0-8.8-7.2-16-16-16h-16v96zm80-112c0-8.8 7.2-16 16-16h48c8.8 0 16 7.2 16 16s-7.2 16-16 16h-32v32h32c8.8 0 16 7.2 16 16s-7.2 16-16 16h-32v48c0 8.8-7.2 16-16 16s-16-7.2-16-16V368"/></svg></span> Download the presentation</a></p>
<h2 id="workflow-from-previous-session">Workflow from previous session</h2>
<p>If you didn&rsquo;t finish the previous part or didn&rsquo;t do the optional exercises, you can restart from a fully commented workflow with a supplementary .fastq files quality check rule and multithreading implemented in all rules. You can download all the files (workflow and config) <a href="https://github.com/sib-swiss/containers-snakemake-training/tree/main/docs/solutions/session4">here</a> or copy them after cloning the course repository locally:
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/sib-swiss/containers-snakemake-training.git<span class="w">  </span><span class="c1"># Clone repository</span>
<span class="nb">cd</span><span class="w"> </span>containers-snakemake-training/<span class="w">  </span><span class="c1"># Go in repository</span>
cp<span class="w"> </span>-r<span class="w"> </span>docs/solutions/session4<span class="w"> </span>destination_path<span class="w">  </span><span class="c1"># Copy folder where needed; adapt destination_path to required path</span>
</code></pre></div></p>
<h2 id="exercises">Exercises</h2>
<p>In this last series exercises, you will learn how to get a better idea of the resources used by your workflow and how to optimise their usage, as well as the necessary command line arguments, files and rule directives to run your workflow in an SLURM-based High Performance Computing (HPC) environment. In addition, you will also learn how to set up configuration profiles and further develop the Snakefile to define rule-specific settings.</p>
<h3 id="benchmarking-a-workflow">Benchmarking a workflow</h3>
<p>Knowing how many resources are being used by each job can be very useful to optimise your workflow for both local and remote execution. The <code>benchmark</code> directive allows you to do exactly that. Adding it in your rule definitions will trigger the recording of several metrics for every job generated by your workflow execution. Each job will have an associated benchmark file with the following information:</p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>s</strong></th>
<th style="text-align: center;"><strong>h: m: s</strong></th>
<th style="text-align: center;"><strong>max_rss</strong></th>
<th style="text-align: center;"><strong>max_vms</strong></th>
<th style="text-align: center;"><strong>max_uss</strong></th>
<th style="text-align: center;"><strong>max_pss</strong></th>
<th style="text-align: center;"><strong>io_in</strong></th>
<th style="text-align: center;"><strong>io_out</strong></th>
<th style="text-align: center;"><strong>mean_load</strong></th>
<th style="text-align: center;"><strong>cpu_time</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">31.3048</td>
<td style="text-align: center;">0:00:31</td>
<td style="text-align: center;">763.04</td>
<td style="text-align: center;">904.29</td>
<td style="text-align: center;">757.89</td>
<td style="text-align: center;">758.37</td>
<td style="text-align: center;">1.81</td>
<td style="text-align: center;">230.18</td>
<td style="text-align: center;">37.09</td>
<td style="text-align: center;">11.78</td>
</tr>
</tbody>
</table>
<ul>
<li><code>s</code> and <code>h:m:s</code> give the job wall clock time (in seconds and hours-minutes-seconds, respectively), which is the actual time taken from the start of a software to its end. You can use these results to infer a safe value for the <code>runtime</code> keyword</li>
<li>Likewise, you can use <code>max_rss</code> (shown in megabytes) to figure out how much memory was used by the job and use this value in the <code>memory</code> keyword</li>
</ul>
<details class="info">
<summary>What are the other columns?</summary>
<p>In case you are wondering about the other columns of the table, the <a href="https://snakemake.readthedocs.io/en/v8.20.5/snakefiles/rules.html#benchmark-rules">official documentation</a> has detailed explanations about their content.</p>
</details>
<p><strong>Exercise:</strong> Add the and <code>benchmark</code> directive to the rules. You can follow the same logic as you did with the <code>log</code> directive.</p>
<details class="tip">
<summary>Benchmarks and wildcards</summary>
<p><code>benchmark</code> directives must contain the same <code>wildcards</code> as the <code>output</code> directive, here <code>sample</code></p>
</details>
<details class="success">
<summary>Answer</summary>
<p>The code snippet below shows the answer for the <code>reads_quantification_genes</code> rule. You can do the same with the other rules.
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">rule</span> <span class="n">reads_quantification_genes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This rule quantifies the reads of a bam file mapping on genes and produces</span>
<span class="sd">    a count table for all genes of the assembly</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="n">bam_once_sorted</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">sam_to_bam</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">bam_sorted</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="n">gene_level</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_genes_read_quantification.tsv&#39;</span><span class="p">,</span>
        <span class="n">gene_summary</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_genes_read_quantification.summary&#39;</span>
    <span class="n">params</span><span class="p">:</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">]</span>
    <span class="n">log</span><span class="p">:</span>
        <span class="s1">&#39;logs/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_genes_read_quantification.log&#39;</span>
<span class="hll">    <span class="n">benchmark</span><span class="p">:</span>
</span><span class="hll">        <span class="s1">&#39;benchmarks/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_genes_read_quantification.txt&#39;</span> <span class="c1"># Path to the benchmark file</span>
</span>    <span class="n">threads</span><span class="p">:</span> <span class="mi">2</span>
    <span class="n">container</span><span class="p">:</span>
        <span class="s1">&#39;https://depot.galaxyproject.org/singularity/subread%3A2.0.6--he4a0461_2&#39;</span>
    <span class="n">shell</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        echo &quot;Counting reads mapping on genes in &lt;{input.bam_once_sorted}&gt;&quot; &gt; {log}</span>
<span class="sd">        featureCounts -t exon -g gene_id -s 2 -p --countReadPairs \</span>
<span class="sd">        -B -C --largestOverlap --verbose -F GTF \</span>
<span class="sd">        -a {params.annotations} -o {output.gene_level} {input.bam_once_sorted} &amp;&gt;&gt; {log}</span>
<span class="sd">        echo &quot;Renaming output files&quot; &gt;&gt; {log}</span>
<span class="sd">        mv {output.gene_level}.summary {output.gene_summary}</span>
<span class="sd">        echo &quot;Results saved in &lt;{output.gene_level}&gt;&quot; &gt;&gt; {log}</span>
<span class="sd">        echo &quot;Report saved in &lt;{output.gene_summary}&gt;&quot; &gt;&gt; {log}</span>
<span class="sd">        &#39;&#39;&#39;</span>
</code></pre></div></td></tr></table></div></p>
</details>
<p>This means that a workflow has to run at least once to produce benchmark values, which leads to a &ldquo;vicious circle&rdquo;: to run a workflow, you need benchmark information. But to get them, you need to run the workflow. A good practice is to make a first run with only a small part of the samples and sensible resource requirements to allow for the benchmarking to happen.</p>
<h3 id="controlling-memory-usage-and-runtime">Controlling memory usage and runtime</h3>
<p>Controlling resources such as the amount of memory or runtime of each job is a very good way to optimise resource usage in a workflow. This ensures your instance (computer, HPC cluster&hellip;) won&rsquo;t run out of memory during computation (which could interrupt jobs or even crash the instance) and that your jobs will run in a reasonable amount of time (a job taking more time to run than usual might be a sign that something is going on).</p>
<details class="info">
<summary>Resource usage and schedulers</summary>
<p>Optimising resource usage is especially important when submitting jobs to a scheduler (for instance on a cluster), as it allows a better and more precise definition of your job priority: jobs with low threads/memory/runtime requirements often have a higher priority than heavy jobs, which means they will often start first.</p>
</details>
<p>Controlling memory usage and runtime in Snakemake is very simple: you only need to need to use the <code>resources</code> directive with the <code>memory</code> or <code>runtime</code> keywords and in most software, you don&rsquo;t even need to specify the amount of memory available to the software via a parameter.</p>
<p>Here are some suggested values of memory usage in the current workflow:</p>
<ul>
<li><code>fastq_trim</code>: 500 MB</li>
<li><code>read_mapping</code>: 2 GB</li>
<li><code>sam_to_bam</code>: 250 MB</li>
<li><code>reads_quantification_genes</code>: 500 MB</li>
</ul>
<p><strong>Exercise:</strong> Implement memory usage limits in the workflow.</p>
<details class="tip">
<summary>Two ways to declare memory values </summary>
<p>There are two ways to declare memory values in <code>resources</code>:</p>
<ol>
<li><code>mem_&lt;unit&gt; = n</code></li>
<li><code>mem = 'n&lt;unit&gt;'</code>: in this case, you must pass a <strong>string</strong>, so you have to enclose <code>n&lt;unit&gt;</code> with quotes <code>''</code></li>
</ol>
<p><code>&lt;unit&gt;</code> is a unit in [B, KB, MB, GB, TB, PB, KiB, MiB, GiB, TiB, PiB] and <code>n</code> is a <strong>float</strong>.</p>
</details>
<details class="success">
<summary>Answer</summary>
<p>We implemented memory usage control in all the rules so that you can check everything. We implemented all the memory usage definitions using <code>mem_mb</code>. Feel free to copy this in your Snakefile:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">rule</span> <span class="n">fastq_trim</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This rule trims paired-end reads to improve their quality. Specifically, it removes:</span>
<span class="sd">    - Low quality bases</span>
<span class="sd">    - A stretches longer than 20 bases</span>
<span class="sd">    - N stretches</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="n">reads1</span> <span class="o">=</span> <span class="s1">&#39;data/</span><span class="si">{sample}</span><span class="s1">_1.fastq&#39;</span><span class="p">,</span>
        <span class="n">reads2</span> <span class="o">=</span> <span class="s1">&#39;data/</span><span class="si">{sample}</span><span class="s1">_2.fastq&#39;</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="n">trim1</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_atropos_trimmed_1.fastq&#39;</span><span class="p">,</span>
        <span class="n">trim2</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_atropos_trimmed_2.fastq&#39;</span>
    <span class="n">log</span><span class="p">:</span>
        <span class="s1">&#39;logs/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_atropos_trimming.log&#39;</span>
    <span class="n">benchmark</span><span class="p">:</span>
        <span class="s1">&#39;benchmarks/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_atropos_trimming.txt&#39;</span>
<span class="hll">    <span class="n">resources</span><span class="p">:</span>  <span class="c1"># Add directive</span>
</span><span class="hll">        <span class="n">mem_mb</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># Add keyword and value with format 1</span>
</span><span class="hll">        <span class="c1"># mem = &#39;500MB&#39;  # Add keyword and value with format 2</span>
</span>    <span class="n">threads</span><span class="p">:</span> <span class="mi">2</span>
    <span class="n">container</span><span class="p">:</span>
        <span class="s1">&#39;https://depot.galaxyproject.org/singularity/atropos%3A1.1.32--py312hf67a6ed_2&#39;</span>
    <span class="n">shell</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        echo &quot;Trimming reads in &lt;{input.reads1}&gt; and &lt;{input.reads2}&gt;&quot; &gt; {log}</span>
<span class="sd">        atropos trim -q 20,20 --minimum-length 25 --trim-n --preserve-order --max-n 10 \</span>
<span class="sd">        --no-cache-adapters -a &quot;A{{20}}&quot; -A &quot;A{{20}}&quot; --threads {threads} \</span>
<span class="sd">        -pe1 {input.reads1} -pe2 {input.reads2} -o {output.trim1} -p {output.trim2} &amp;&gt;&gt; {log}</span>
<span class="sd">        echo &quot;Trimmed files saved in &lt;{output.trim1}&gt; and &lt;{output.trim2}&gt; respectively&quot; &gt;&gt; {log}</span>
<span class="sd">        echo &quot;Trimming report saved in &lt;{log}&gt;&quot; &gt;&gt; {log}</span>
<span class="sd">        &#39;&#39;&#39;</span>

<span class="n">rule</span> <span class="n">read_mapping</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This rule maps trimmed reads of a fastq onto a reference assembly.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="n">trim1</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">fastq_trim</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">trim1</span><span class="p">,</span>
        <span class="n">trim2</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">fastq_trim</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">trim2</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="n">sam</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapped_reads.sam&#39;</span><span class="p">,</span>
        <span class="n">report</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapping_report.txt&#39;</span>
    <span class="n">params</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span>
    <span class="n">log</span><span class="p">:</span>
        <span class="s1">&#39;logs/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapping.log&#39;</span>
    <span class="n">benchmark</span><span class="p">:</span>
        <span class="s1">&#39;benchmarks/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapping.txt&#39;</span>
<span class="hll">    <span class="n">resources</span><span class="p">:</span>
</span><span class="hll">        <span class="n">mem_mb</span> <span class="o">=</span> <span class="mi">2000</span>
</span>    <span class="n">threads</span><span class="p">:</span> <span class="mi">4</span>
    <span class="n">container</span><span class="p">:</span>
        <span class="s1">&#39;https://depot.galaxyproject.org/singularity/hisat2%3A2.2.1--hdbdd923_6&#39;</span>
    <span class="n">shell</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        echo &quot;Mapping the reads&quot; &gt; {log}</span>
<span class="sd">        hisat2 --dta --fr --no-mixed --no-discordant --time --new-summary --no-unal \</span>
<span class="sd">        -x {params.index} --threads {threads} \</span>
<span class="sd">        -1 {input.trim1} -2 {input.trim2} -S {output.sam} --summary-file {output.report} 2&gt;&gt; {log}</span>
<span class="sd">        echo &quot;Mapped reads saved in &lt;{output.sam}&gt;&quot; &gt;&gt; {log}</span>
<span class="sd">        echo &quot;Mapping report saved in &lt;{output.report}&gt;&quot; &gt;&gt; {log}</span>
<span class="sd">        &#39;&#39;&#39;</span>

<span class="n">rule</span> <span class="n">sam_to_bam</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This rule converts a sam file to bam format, sorts it and indexes it.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="n">sam</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">read_mapping</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">sam</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="n">bam</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapped_reads.bam&#39;</span><span class="p">,</span>
        <span class="n">bam_sorted</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapped_reads_sorted.bam&#39;</span><span class="p">,</span>
        <span class="n">index</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapped_reads_sorted.bam.bai&#39;</span>
    <span class="n">log</span><span class="p">:</span>
        <span class="s1">&#39;logs/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapping_sam_to_bam.log&#39;</span>
    <span class="n">benchmark</span><span class="p">:</span>
        <span class="s1">&#39;benchmarks/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapping_sam_to_bam.txt&#39;</span>
<span class="hll">    <span class="n">resources</span><span class="p">:</span>
</span><span class="hll">        <span class="n">mem_mb</span> <span class="o">=</span> <span class="mi">250</span>
</span>    <span class="n">threads</span><span class="p">:</span> <span class="mi">2</span>
    <span class="n">container</span><span class="p">:</span>
        <span class="s1">&#39;https://depot.galaxyproject.org/singularity/samtools%3A1.21--h50ea8bc_0&#39;</span>
    <span class="n">shell</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        echo &quot;Converting &lt;{input.sam}&gt; to BAM format&quot; &gt; {log}</span>
<span class="sd">        samtools view {input.sam} --threads {threads} -b -o {output.bam} 2&gt;&gt; {log}</span>
<span class="sd">        echo &quot;Sorting .bam file&quot; &gt;&gt; {log}</span>
<span class="sd">        samtools sort {output.bam} --threads {threads} -O bam -o {output.bam_sorted} 2&gt;&gt; {log}</span>
<span class="sd">        echo &quot;Indexing sorted .bam file&quot; &gt;&gt; {log}</span>
<span class="sd">        samtools index -b {output.bam_sorted} -o {output.index} 2&gt;&gt; {log}</span>
<span class="sd">        echo &quot;Sorted file saved in &lt;{output.bam_sorted}&gt;&quot; &gt;&gt; {log}</span>
<span class="sd">        &#39;&#39;&#39;</span>

<span class="n">rule</span> <span class="n">reads_quantification_genes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This rule quantifies the reads of a bam file mapping on genes and produces</span>
<span class="sd">    a count table for all genes of the assembly. The strandedness parameter</span>
<span class="sd">    is determined by get_strandedness().</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="n">bam_once_sorted</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">sam_to_bam</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">bam_sorted</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="n">gene_level</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_genes_read_quantification.tsv&#39;</span><span class="p">,</span>
        <span class="n">gene_summary</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_genes_read_quantification.summary&#39;</span>
    <span class="n">params</span><span class="p">:</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">]</span>
    <span class="n">log</span><span class="p">:</span>
        <span class="s1">&#39;logs/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_genes_read_quantification.log&#39;</span>
    <span class="n">benchmark</span><span class="p">:</span>
        <span class="s1">&#39;benchmarks/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_genes_read_quantification.txt&#39;</span>
<span class="hll">    <span class="n">resources</span><span class="p">:</span>
</span><span class="hll">        <span class="n">mem_mb</span> <span class="o">=</span> <span class="mi">500</span>
</span>    <span class="n">threads</span><span class="p">:</span> <span class="mi">2</span>
    <span class="n">container</span><span class="p">:</span>
        <span class="s1">&#39;https://depot.galaxyproject.org/singularity/subread%3A2.0.6--he4a0461_2&#39;</span>
    <span class="n">shell</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        echo &quot;Counting reads mapping on genes in &lt;{input.bam_once_sorted}&gt;&quot; &gt; {log}</span>
<span class="sd">        featureCounts -t exon -g gene_id -s 2 -p --countReadPairs \</span>
<span class="sd">        -B -C --largestOverlap --verbose -F GTF \</span>
<span class="sd">        -a {params.annotations} -T {threads} -o {output.gene_level} {input.bam_once_sorted} &amp;&gt;&gt; {log}</span>
<span class="sd">        echo &quot;Renaming output files&quot; &gt;&gt; {log}</span>
<span class="sd">        mv {output.gene_level}.summary {output.gene_summary}</span>
<span class="sd">        echo &quot;Results saved in &lt;{output.gene_level}&gt;&quot; &gt;&gt; {log}</span>
<span class="sd">        echo &quot;Report saved in &lt;{output.gene_summary}&gt;&quot; &gt;&gt; {log}</span>
<span class="sd">        &#39;&#39;&#39;</span>
</code></pre></div></td></tr></table></div></p>
</details>
<p>In the following section we will see that the values established in <code>resources</code> will be very useful to communicate with the job schedulers.</p>
<h3 id="setting-up-snakemake-to-send-jobs-via-the-slurm-job-scheduler">Setting up Snakemake to send jobs via the SLURM job scheduler</h3>
<p>Running jobs remotely on an HPC environment usually requires interaction with job schedulers such as SLURM. Thankfully, adapting our workflow to send jobs via a scheduler does not require a lot of changes. In this section you will use the <code>cluster-generic</code> plugin to send jobs via SLURM.</p>
<details class="tip">
<summary>Snakemake plugins</summary>
<p>In Snakemake v8+, interaction with job schedulers requires the installation of certain plugins. There are multiple plugins available for different schedulers. You can find them <a href="https://snakemake.github.io/snakemake-plugin-catalog/index.html">here</a>.</p>
</details>
<p>In this tutorial, you will use the <code>cluster-generic</code> plugin and use it to configure how to send jobs through SLURM. While there is a <a href="https://snakemake.github.io/snakemake-plugin-catalog/plugins/executor/slurm.html">SLURM-specific plugin</a>, we will focus on the <a href="https://snakemake.github.io/snakemake-plugin-catalog/plugins/executor/cluster-generic.html"><code>cluster-generic</code></a> one because it can be used with any scheduler.</p>
<p>Among others, the <code>cluster-generic</code> plugin can take the following settings, which can be passed in different ways:</p>
<ul>
<li><code>--cluster-generic-submit-cmd</code>: command that will be used to submit each job to the cluster. Since we are using SLURM, the command is <code>sbatch</code>. This string can contain any valid <a href="https://slurm.schedmd.com/sbatch.html"><code>sbatch</code> arguments</a> and use values from the <code>Snakefile</code> (<em>e.g.</em> using <code>threads</code> specified in the Snakefile as a value for the <code>--cpus-per-task</code> argument)</li>
<li><code>--cluster-generic-cancel-cmd</code>: command to use to cancel jobs. This is important if you want to stop your workflow while jobs are running while also cancel the running jobs</li>
</ul>
<p>Then, you will need to tell Snakemake to run the workflow through SLURM. An important parameter when doing so is <code>--jobs</code>, which will tell Snakemake how many jobs it can submit concurrently. In addition, you will also need to specify which executor plugin to use and the required settings:
<div class="highlight"><pre><span></span><code>snakemake<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--executor<span class="w"> </span>cluster-generic<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--cluster-generic-submit-cmd<span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s1">&#39;sbatch &lt;slurm_arguments&gt;&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--cluster-generic-cancel-cmd<span class="w"> </span><span class="s1">&#39;scancel&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--jobs<span class="w"> </span><span class="m">2</span>
</code></pre></div></p>
<p>The command above will:</p>
<ul>
<li>Tell Snakemake to use the <code>cluster-generic</code> plugin</li>
<li>Use the <code>sbatch</code> command to submit jobs</li>
<li>Use the <code>scancel</code> command to cancel submitted jobs if you stop the execution of the workflow</li>
<li>Set the maximum number of simultaneously running jobs to 2</li>
</ul>
<p>As you can see, the command to launch the workflow can get quite long. Thankfully, Snakemake allows the usage of configuration profiles to store all of these settings in a file, increasing reproducibility and also simplifying running your workflow. The next section will show how to set up a config file.</p>
<h4 id="using-configuration-profiles">Using configuration profiles</h4>
<p>Configuration profiles allow you to specify settings regarding the execution of your workflow. Currently, Snakemake supports two types of profiles: global and workflow-specific. In this tutorial we will focus on workflow-specific profiles.</p>
<p><strong>Exercise:</strong> Create a workflow profile named <code>slurm_profile</code> by:</p>
<ol>
<li>Creating a directory named <code>slurm_profile</code> in the project directory.</li>
<li>Creating a <code>config.yaml</code> file inside <code>slurm_profile</code>.</li>
</ol>
<details class="tip">
<summary>File structure example</summary>
<p>Your file structure should resemble this:
<div class="highlight"><pre><span></span><code>│── config
│   └── config.yaml
<span class="hll">│── slurm_profile
</span><span class="hll">│   └── config.yaml
</span>└── workflow
    │── Snakefile
    │── envs
    │   │── tool1.yaml
    │   └── tool2.yaml
    │── rules
    │   │── module1.smk
    │   └── module2.smk
    └── scripts
        │── script1.py
        └── script2.R
</code></pre></div></p>
</details>
<p>The <code>config.yaml</code> file inside the <code>slurm_profile</code> directory can contain multiple settings related to the execution of the workflow. Below you can find an example of configuration file:
<div class="highlight"><pre><span></span><code><span class="nt">executor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster-generic</span>
<span class="nt">cluster-generic-submit-cmd</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;sbatch</span><span class="nv"> </span><span class="s">--job-name={rule}_{wildcards}</span><span class="nv"> </span><span class="s">--cpus-per-task={threads}&#39;</span>
<span class="nt">jobs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</code></pre></div></p>
<p><strong>Exercise:</strong> What do <code>--job-name={rule}_{wildcards}</code> and <code>--cpus-per-task={threads}</code> do?</p>
<details class="success">
<summary>Answer</summary>
<p>These settings allow binding information defined in the workflow to SLURM arguments such as <code>--job-name</code> or <code>--cpus-per-task</code>. For example, a rule where <code>threads: 2</code>, <code>--cpus-per-task={threads}</code> will become <code>--cpus-per-task=2</code>, indicating SLURM that the job should have 2 cpus available.</p>
</details>
<p><strong>Exercise:</strong> Add the required SLURM argument to:</p>
<ul>
<li>Log the SLURM output of each job to a file in <code>slurm_logs/{rule}/{rule}_{wildcards}.log</code></li>
<li>Use the thread number specified in each rule during job submission</li>
<li>Use the <code>scancel</code> command to cancel running jobs</li>
</ul>
<details class="tip">
<summary>SLURM arguments</summary>
<p>You can find the SLURM argument to use by running <code>sbatch -h</code> or by checking this <a href="https://slurm.schedmd.com/pdfs/summary.pdf">SLURM cheatsheet</a>.</p>
</details>
<details class="warning">
<summary>Make sure <code>slurm_logs</code> exists!</summary>
<p>In older SLURM versions, the directory <code>slurm_logs</code> needed to exist before running the workflow! Therefore, in order to be able to save the logs into a directory, you need to have created the folder before running Snakemake. There are two ways to go about this:</p>
<ul>
<li>Manually create the folder before running the workflow</li>
<li>Adding the directory creation command in <code>cluster-generic-submit-cmd</code>. This option ensures that no problems arise if you are running the workflow for the very first time</li>
</ul>
</details>
<details class="success">
<summary>Answer</summary>
<p>Your config file should look like this:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nt">executor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster-generic</span>
<span class="nt">cluster-generic-submit-cmd</span><span class="p">:</span>
<span class="w">    </span><span class="s">&quot;mkdir</span><span class="nv"> </span><span class="s">-p</span><span class="nv"> </span><span class="s">slurm_logs/{rule}</span><span class="nv"> </span><span class="s">&amp;&amp;</span>
<span class="w">    </span><span class="s">sbatch</span>
<span class="w">        </span><span class="s">--job-name={rule}_{wildcards}</span>
<span class="w">        </span><span class="s">--cpus-per-task={threads}</span>
<span class="w">        </span><span class="s">--output=slurm_logs/{rule}/{rule}_{wildcards}.log&quot;</span>
<span class="nt">cluster-generic-cancel-cmd</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">scancel</span>
</code></pre></div></td></tr></table></div>
Here&rsquo;s a quick breakdown of the arguments:</p>
<ul>
<li><code>mkdir -p slurm_logs/{rule}</code>: create directory where logs will be saved</li>
<li><code>--job-name={rule}_{wildcards}</code>: set job name to rule name and wildcards</li>
<li><code>--cpus-per-task={threads}</code>: set number of CPUs to number of threads defined in the rule</li>
<li><code>--output=slurm_logs/{rule}/{rule}_{wildcards}.log</code>: set output file for job logs to <code>slurm_logs/{rule}/{rule}_{wildcards}.log</code></li>
<li><code>cluster-generic-cancel-cmd: scancel</code>: set command to cancel jobs to <code>scancel</code></li>
</ul>
</details>
<h3 id="passing-rule-specific-resources-to-the-job-scheduler">Passing rule-specific resources to the job scheduler</h3>
<p>As shown <a href="#controlling-memory-usage-and-runtime">before</a>, it is possible to specify rule-specific memory usage to have better control over how the workflow uses the available resources with the <code>resources</code> directive:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">rule</span> <span class="n">myrule</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="o">...</span>
<span class="hll">    <span class="n">resources</span><span class="p">:</span>
</span><span class="hll">        <span class="n">mem_mb</span> <span class="o">=</span> <span class="mi">100</span>
</span>    <span class="n">shell</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        cp {input} {output};</span>
<span class="sd">        &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div></p>
<p>This will ensure that jobs spawn from rule <code>myrule</code> never use more than 100 MB of RAM. Note that the jobs will crash if they surpass this limit, so try to account for some wiggle room when you set resources.</p>
<p><strong>Exercise:</strong> Update the configuration profile to set the amount of memory per job to the values specified in each rule through the <code>resources</code> directive. To simplify things, make sure all rule memory requirements are set in megabytes.</p>
<div class="admonition tip">
<p class="admonition-title">Think about the SLURM parameter you need to use and how to set its value</p>
</div>
<details class="success">
<summary>Answer</summary>
<p>The SLURM parameter to use is <code>--mem</code>. Its value should be set to the <code>mem_mb</code> keyword defined in the <code>resources</code> directive:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nt">executor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster-generic</span>
<span class="nt">cluster-generic-submit-cmd</span><span class="p">:</span>
<span class="w">    </span><span class="s">&quot;mkdir</span><span class="nv"> </span><span class="s">-p</span><span class="nv"> </span><span class="s">logs/{rule}</span><span class="nv"> </span><span class="s">&amp;&amp;</span>
<span class="w">    </span><span class="s">sbatch</span>
<span class="w">        </span><span class="s">--job-name={rule}_{wildcards}</span>
<span class="w">        </span><span class="s">--cpus-per-task={threads}</span>
<span class="w">        </span><span class="s">--output=slurm_logs/{rule}/{rule}_{wildcards}.log</span>
<span class="hll"><span class="w">        </span><span class="s">--mem={resources.mem_mb}&quot;</span>
</span><span class="nt">cluster-generic-cancel-cmd</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">scancel</span>
</code></pre></div></td></tr></table></div></p>
</details>
<p>In addition to remote execution parameters, a configuration profile allows to set anything that can be passed through the command line. This can significantly simplify launching a workflow if there are a lot of arguments to pass when to run it. For example, the extra lines below indicate that we should run a maximum of 2 jobs at a time and to use conda and singularity:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nt">executor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster-generic</span>
<span class="nt">cluster-generic-submit-cmd</span><span class="p">:</span>
<span class="w">  </span><span class="s">&quot;mkdir</span><span class="nv"> </span><span class="s">-p</span><span class="nv"> </span><span class="s">slurm_logs/{rule}</span><span class="nv"> </span><span class="s">&amp;&amp;</span>
<span class="w">  </span><span class="s">sbatch</span>
<span class="w">    </span><span class="s">--job-name={rule}-{wildcards}</span>
<span class="w">    </span><span class="s">--cpus-per-task={threads}</span>
<span class="w">    </span><span class="s">--output=slurm_logs/{rule}/{rule}_{wildcards}.log</span>
<span class="w">    </span><span class="s">--mem={resources.mem_mb}&quot;</span>
<span class="nt">cluster-generic-cancel-cmd</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">scancel</span>
<span class="hll"><span class="nt">jobs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span class="hll"><span class="nt">software-deployment-method</span><span class="p">:</span>
</span><span class="hll"><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda</span>
</span><span class="hll"><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apptainer</span>
</span></code></pre></div></td></tr></table></div></p>
<p><strong>Exercise:</strong> Add the <code>jobs</code> and <code>software-deployment-method</code> parameters to your configuration profile.</p>
<h3 id="adapting-the-workflow-to-the-available-resources">Adapting the workflow to the available resources</h3>
<p>Before launching a workflow, it is very important to quantify the resources available in the machine supposed to run it. This information is typically provided by the HPC user guide. In our case, you can use the following commands to know the total number of cores and the amount of memory available in the server:
<div class="highlight"><pre><span></span><code>nproc<span class="w"> </span>--all<span class="w">    </span><span class="c1"># Number of cores</span>
free<span class="w"> </span>-g<span class="w">        </span><span class="c1"># Amount of memory in GB in row &quot;Mem&quot; and column &quot;total&quot;</span>
</code></pre></div></p>
<p><strong>Exercise:</strong> Based on the available resources, figure out if you need to update any of the rule resources.</p>
<details class="success">
<summary>Answer</summary>
<p>The cluster has 48 CPUs and 96 GB of memory, so there is no need to change the resource settings. It is also more than enough to run several jobs in parallel without any problem.</p>
</details>
<details class="bug">
<summary>Always check the available resources</summary>
<p>A very important role of schedulers is to ensure that running jobs do not surpass the total amount of available resources. When a job is asking for more resources than a machine has (<em>e.g.</em> the job asks for 50 CPUs, but the machine only has 20), the HPC (if configured properly) will prevent Snakemake from submitting the job and the workflow will fail. However, if the HPC is not configured properly or if the workflow is running on another type of instance without proper safety checks, Snakemake will be able launch the job but will display the message <code>Waiting for more resources.</code> to indicate that the job is waiting until enough resources are available for it to run, which can never happen. In this case, Snakemake will get stuck and never manage to launch the job.</p>
</details>
<h3 id="final-exercise">Final exercise</h3>
<p><strong>Exercise:</strong> To conclude, run the workflow in the HPC environment with the following command:
<div class="highlight"><pre><span></span><code>snakemake<span class="w"> </span>--profile<span class="w"> </span>slurm_profile
</code></pre></div></p>
<p>You can then see what jobs are being run by using the <code>squeue</code> command in combination with <code>watch</code> to check the status of your workflow on regular intervals (here, 10s):
<div class="highlight"><pre><span></span><code>watch<span class="w"> </span>-n<span class="w"> </span><span class="m">10</span><span class="w"> </span>squeue<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;
</code></pre></div></p>
<p>This will give you information such as the job id, the job status, how long is has been running for, and the reason if the status is <code>PD</code> (pending).</p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>JOBID</strong></th>
<th style="text-align: center;"><strong>PARTITION</strong></th>
<th style="text-align: center;"><strong>NAME</strong></th>
<th style="text-align: center;"><strong>USER</strong></th>
<th style="text-align: center;"><strong>ST</strong></th>
<th style="text-align: center;"><strong>TIME</strong></th>
<th style="text-align: center;"><strong>NODES</strong></th>
<th style="text-align: center;"><strong>NODELIST(REASON)</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">91</td>
<td style="text-align: center;">local</td>
<td style="text-align: center;">read_map</td>
<td style="text-align: center;">user1</td>
<td style="text-align: center;">PD</td>
<td style="text-align: center;">0:00</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">(Resources)</td>
</tr>
<tr>
<td style="text-align: center;">90</td>
<td style="text-align: center;">local</td>
<td style="text-align: center;">read_map</td>
<td style="text-align: center;">user1</td>
<td style="text-align: center;">R</td>
<td style="text-align: center;">0:30</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">localhost</td>
</tr>
</tbody>
</table>
<p>Congratulations, you made it to the end! You are now able to create a Snakemake workflow, make it reproducible thanks to Conda and Docker/Apptainer and even run it in an HPC! This is a great time to get yourself a coffee/tea and celebrate! <img alt="☕" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2615.svg" title=":coffee:" /> <img alt="🍵" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f375.svg" title=":tea:" /></p>
<p>To make things even better, have a look at some <a href="../7_debugging_snakemake/#using-non-conventional-outputs">additional concepts</a> and <a href="https://snakemake.readthedocs.io/en/v8.20.5/snakefiles/best_practices.html">Snakemake&rsquo;s best practices</a>!</p>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-2025 SIB Swiss institute of Bioinformatics - <a href="#__consent">Change cookie settings</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "content.code.copy"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.56dfad97.min.js"></script>
      
    
  </body>
</html>
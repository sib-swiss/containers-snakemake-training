
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../2_introduction_snakemake/">
      
      
        <link rel="next" href="../4_decorating_workflow/">
      
      
      <link rel="icon" href="../../../assets/images/SIB_logo.svg">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.5">
    
    
      
        <title>Making a more general-purpose Snakemake workflow - Introduction to Containers and Snakemake</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6a10b989.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#learning-outcomes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
  You're not viewing the latest version.
  <a href="../../../.."> 
    <strong>Click here to go to latest.</strong>
  </a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Introduction to Containers and Snakemake" class="md-header__button md-logo" aria-label="Introduction to Containers and Snakemake" data-md-component="logo">
      
  <img src="../../../assets/images/SIB_logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Introduction to Containers and Snakemake
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Making a more general-purpose Snakemake workflow
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/sib-swiss/containers-snakemake-training" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    sib-swiss/containers-snakemake-training
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Introduction to Containers and Snakemake" class="md-nav__button md-logo" aria-label="Introduction to Containers and Snakemake" data-md-component="logo">
      
  <img src="../../../assets/images/SIB_logo.svg" alt="logo">

    </a>
    Introduction to Containers and Snakemake
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/sib-swiss/containers-snakemake-training" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    sib-swiss/containers-snakemake-training
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../../precourse/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Precourse preparations
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../../course_schedule/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Course schedule
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Day 1 - Containers
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Day 1 - Containers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../day1/introduction_containers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction to containers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../day1/managing_docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Managing containers and images
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../day1/dockerfiles/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Working with dockerfiles
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../day1/apptainer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Running containers with apptainer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Day 2 - Snakemake
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Day 2 - Snakemake
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../1_guidelines/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    General guidelines
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2_introduction_snakemake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction to Snakemake
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Making a more general-purpose Snakemake workflow
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Making a more general-purpose Snakemake workflow
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-outcomes" class="md-nav__link">
    Learning outcomes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#material" class="md-nav__link">
    Material
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-origin" class="md-nav__link">
    Data origin
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercises" class="md-nav__link">
    Exercises
  </a>
  
    <nav class="md-nav" aria-label="Exercises">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#general-instructions-and-reminders" class="md-nav__link">
    General instructions and reminders
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#downloading-the-data-and-setting-up-the-directory-structure" class="md-nav__link">
    Downloading the data and setting up the directory structure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-rule-to-trim-reads" class="md-nav__link">
    Creating a rule to trim reads
  </a>
  
    <nav class="md-nav" aria-label="Creating a rule to trim reads">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#atropos-options" class="md-nav__link">
    atropos options
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-rule-to-map-trimmed-reads-on-a-reference-genome" class="md-nav__link">
    Creating a rule to map trimmed reads on a reference genome
  </a>
  
    <nav class="md-nav" aria-label="Creating a rule to map trimmed reads on a reference genome">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hisat2-options" class="md-nav__link">
    HISAT2 options
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-rule-to-convert-and-sort-sam-files-to-bam" class="md-nav__link">
    Creating a rule to convert and sort SAM files to BAM
  </a>
  
    <nav class="md-nav" aria-label="Creating a rule to convert and sort SAM files to BAM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samtools-options" class="md-nav__link">
    Samtools options
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-rule-to-count-mapped-reads" class="md-nav__link">
    Creating a rule to count mapped reads
  </a>
  
    <nav class="md-nav" aria-label="Creating a rule to count mapped reads">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#featurecounts-options" class="md-nav__link">
    featureCounts options
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-workflow" class="md-nav__link">
    Running the workflow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#visualising-the-dag-of-the-workflow" class="md-nav__link">
    Visualising the DAG of the workflow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#designing-a-snakemake-workflow-and-debugging-it" class="md-nav__link">
    Designing a Snakemake workflow... and debugging it!
  </a>
  
    <nav class="md-nav" aria-label="Designing a Snakemake workflow... and debugging it!">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#designing-a-workflow" class="md-nav__link">
    Designing a workflow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging-a-workflow" class="md-nav__link">
    Debugging a workflow
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../4_decorating_workflow/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Decorating and optimising a Snakemake workflow
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../5_reproducibility_snakemake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Being reproducible with Snakemake
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-outcomes" class="md-nav__link">
    Learning outcomes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#material" class="md-nav__link">
    Material
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-origin" class="md-nav__link">
    Data origin
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercises" class="md-nav__link">
    Exercises
  </a>
  
    <nav class="md-nav" aria-label="Exercises">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#general-instructions-and-reminders" class="md-nav__link">
    General instructions and reminders
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#downloading-the-data-and-setting-up-the-directory-structure" class="md-nav__link">
    Downloading the data and setting up the directory structure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-rule-to-trim-reads" class="md-nav__link">
    Creating a rule to trim reads
  </a>
  
    <nav class="md-nav" aria-label="Creating a rule to trim reads">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#atropos-options" class="md-nav__link">
    atropos options
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-rule-to-map-trimmed-reads-on-a-reference-genome" class="md-nav__link">
    Creating a rule to map trimmed reads on a reference genome
  </a>
  
    <nav class="md-nav" aria-label="Creating a rule to map trimmed reads on a reference genome">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hisat2-options" class="md-nav__link">
    HISAT2 options
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-rule-to-convert-and-sort-sam-files-to-bam" class="md-nav__link">
    Creating a rule to convert and sort SAM files to BAM
  </a>
  
    <nav class="md-nav" aria-label="Creating a rule to convert and sort SAM files to BAM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samtools-options" class="md-nav__link">
    Samtools options
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-rule-to-count-mapped-reads" class="md-nav__link">
    Creating a rule to count mapped reads
  </a>
  
    <nav class="md-nav" aria-label="Creating a rule to count mapped reads">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#featurecounts-options" class="md-nav__link">
    featureCounts options
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-workflow" class="md-nav__link">
    Running the workflow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#visualising-the-dag-of-the-workflow" class="md-nav__link">
    Visualising the DAG of the workflow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#designing-a-snakemake-workflow-and-debugging-it" class="md-nav__link">
    Designing a Snakemake workflow... and debugging it!
  </a>
  
    <nav class="md-nav" aria-label="Designing a Snakemake workflow... and debugging it!">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#designing-a-workflow" class="md-nav__link">
    Designing a workflow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging-a-workflow" class="md-nav__link">
    Debugging a workflow
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Making a more general-purpose Snakemake workflow</h1>

<h2 id="learning-outcomes">Learning outcomes</h2>
<p><strong>After having completed this chapter you will be able to:</strong></p>
<ul>
<li>Create rules with multiple inputs and outputs</li>
<li>Make the code shorter and more general by using placeholders and wildcards</li>
<li>Optimise the memory usage of a workflow and checking its performances</li>
<li>Visualise a workflow DAG</li>
</ul>
<h2 id="material">Material</h2>
<p><a class="md-button" href="../../../assets/pdf/day2/2_generalising_snakemake.pdf"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M0 64C0 28.7 28.7 0 64 0h160v128c0 17.7 14.3 32 32 32h128v144H176c-35.3 0-64 28.7-64 64v144H64c-35.3 0-64-28.7-64-64V64zm384 64H256V0l128 128zM176 352h32c30.9 0 56 25.1 56 56s-25.1 56-56 56h-16v32c0 8.8-7.2 16-16 16s-16-7.2-16-16V368c0-8.8 7.2-16 16-16zm32 80c13.3 0 24-10.7 24-24s-10.7-24-24-24h-16v48h16zm96-80h32c26.5 0 48 21.5 48 48v64c0 26.5-21.5 48-48 48h-32c-8.8 0-16-7.2-16-16V368c0-8.8 7.2-16 16-16zm32 128c8.8 0 16-7.2 16-16v-64c0-8.8-7.2-16-16-16h-16v96h16zm80-112c0-8.8 7.2-16 16-16h48c8.8 0 16 7.2 16 16s-7.2 16-16 16h-32v32h32c8.8 0 16 7.2 16 16s-7.2 16-16 16h-32v48c0 8.8-7.2 16-16 16s-16-7.2-16-16V368z"/></svg></span> Download the presentation</a></p>
<h2 id="data-origin">Data origin</h2>
<p>The data we will use during the exercises was produced <a href="https://pubmed.ncbi.nlm.nih.gov/31654410/">in this work</a>. Briefly, the team studied the transcriptional response of a strain of baker&rsquo;s yeast, <a href="https://en.wikipedia.org/wiki/Saccharomyces_cerevisiae"><em>Saccharomyces cerevisiae</em></a>, facing environments with different amount of CO<sub>2</sub>. To this end, they performed <strong>150 bp paired-end</strong> sequencing of mRNA-enriched samples. Detailed information on all the samples are available <a href="https://www.ncbi.nlm.nih.gov/bioproject/PRJNA550078">here</a>, but just know that for the purpose of the course, we selected <strong>6 samples</strong> (<strong>3 replicates per condition</strong>, <strong>low</strong> and <strong>high CO<sub>2</sub></strong>) and <strong>down-sampled</strong> them to <strong>1 million read-pairs each</strong> to reduce computation times.</p>
<h2 id="exercises">Exercises</h2>
<p>One of the aims of today&rsquo;s course is to develop a basic, yet efficient, workflow to analyse RNAseq data. This workflow takes reads coming from RNA sequencing as inputs and outputs a list of genes that are differentially expressed between two conditions. The files containing the reads are in <a href="https://en.wikipedia.org/wiki/FASTQ_format">FASTQ format</a> and the output will be a tab-separated file containing a list of genes with expression changes, results of statistical tests&hellip;</p>
<p>In this series of exercises, we will create the &lsquo;backbone&rsquo; of the workflow, <em>i.e.</em> the rules that are the most computationally expensive, namely:</p>
<ul>
<li>A rule to trim poor-quality reads</li>
<li>A rule to map the trimmed reads on a reference genome</li>
<li>A rule to convert and sort files from the SAM format to the BAM format</li>
<li>A rule to count the reads mapping on each gene</li>
</ul>
<p>At the end of this series of exercises, the DAG of your workflow should look like this:</p>
<figure align="center">
<p><img alt="backbone_rulegraph" src="../../../assets/images/backbone_rulegraph.png" />
  </p>
<figcaption>Rulegraph of the workflow at <br>the end of the session</figcaption>
</figure>
<div class="admonition note">
<p class="admonition-title">Designing and debugging a workflow</p>
<p>If you have problems designing your Snakemake workflow or debugging it, you can find some help <a href="#designing-a-snakemake-workflow-and-debugging-it">here</a>.</p>
</div>
<h3 id="general-instructions-and-reminders">General instructions and reminders</h3>
<p>In each rule, you should try (as much as possible) to:</p>
<ul>
<li>Choose meaningful rule names</li>
<li>Use rules dependency, with the syntax <code>rules.&lt;rule_name&gt;.output</code><ul>
<li>If you use numbered outputs, the syntax becomes <code>rules.&lt;rule_name&gt;.output[n]</code> (with <code>n</code> starting at 0)</li>
<li>If you use named outputs, the syntax becomes <code>rules.&lt;rule_name&gt;.output.&lt;output_name&gt;</code></li>
</ul>
</li>
<li>Use placeholders</li>
<li>Use wildcards<ul>
<li>Choose meaningful wildcard names</li>
<li>The <code>output</code>, <code>log</code>, and <code>benchmark</code> directives must have the same wildcard names!</li>
<li>You can use the same wildcard names in multiple rules for consistency and readability, but Snakemake will treat them as independent wildcards and their values will not be shared: rules are self-contained and wildcards are local to each rule (<a href="http://ivory.idyll.org/blog/2023-snakemake-slithering-wildcards.html">see a very nice summary on wildcards</a>)</li>
</ul>
</li>
<li>Use multiple inputs/outputs (when needed/possible)</li>
<li>Create a log file with the <code>log</code> directive</li>
<li>Create a benchmark file with the <code>benchmark</code> directive</li>
</ul>
<p>If you have a doubt, do not hesitate to test your workflow logic with a dry-run (the <code>-n</code> flag): <code>snakemake --cores 1 -n &lt;target&gt;</code>. Snakemake will then display all the jobs required to generate the target. To obtain additional information on why a specific job is necessary, run Snakemake with the <code>-r</code> flag (which can be -and usually is- combined with <code>-n</code>): <code>snakemake --cores 1 -n -r &lt;target&gt;</code>. For each job, Snakemake will print a <em>reason</em> field explaining why the job was required. To visualize the exact command executed by each job (with the placeholders and wildcards replaced by their values), run snakemake with the <code>-p</code> flag: <code>snakemake --cores 1 -n -r -p &lt;target&gt;</code>.</p>
<h3 id="downloading-the-data-and-setting-up-the-directory-structure">Downloading the data and setting up the directory structure</h3>
<p>In this part, we will download the data and start building the directory structure of our workflow according to the <a href="https://snakemake.readthedocs.io/en/stable/snakefiles/deployment.html">official recommendations</a>. We already starting doing so in the previous series of exercises and ultimately, it should resemble this:</p>
<div class="highlight"><pre><span></span><code>│── .gitignore
│── README.md
│── LICENSE.md
│── benchmarks
│   │── sample1.fastq
│   └── sample2.fastq
│── config
│   │── config.yaml
│   └── some-sheet.tsv
│── data
│   │── sample1.fastq
│   └── sample2.fastq
│── images
│   └── rulegraph.svg
│── logs
│   │── sample1.log
│   └── sample2.log
│── results
│   │── sample1
│   │   └── sample1.bam
│   │── sample2
│   │   └── sample2.bam
│   └── DEG_list.tsv
│── resources
│   │── Scerevisiae.fasta
│   └── Scerevisiae.gtf
└── workflow
    │── envs
    │   │── tool1.yaml
    │   └── tool2.yaml
    │── rules
    │   │── module1.smk
    │   └── module2.smk
    │── scripts
    │   │── script1.py
    │   └── script2.R
    └── Snakefile
</code></pre></div>
<p>For now, the main thing to remember is that the workflow code goes into a subfolder called <code>workflow</code> and the rest is mostly input/output files, except for the <code>config</code> subfolder, which will be explained later. All output files generated in the workflow should be stored under <code>results/</code>.</p>
<p>Now, let&rsquo;s download the data, uncompress it and build the first part of the directory structure.</p>
<div class="highlight"><pre><span></span><code>ssh<span class="w"> </span>-i<span class="w"> </span>~/.ssh/key_username.pem<span class="w"> </span>username@18.195.170.182<span class="w">  </span><span class="c1"># Connect to the server</span>
wget<span class="w"> </span>https://containers-snakemake-training.s3.eu-central-1.amazonaws.com/snakemake_rnaseq.tar.gz<span class="w">  </span><span class="c1"># Download the data</span>
tar<span class="w"> </span>-xvf<span class="w"> </span>snakemake_rnaseq.tar.gz<span class="w">  </span><span class="c1"># Uncompress the archive</span>
rm<span class="w"> </span>snakemake_rnaseq.tar.gz<span class="w">  </span><span class="c1"># Delete the archive</span>
<span class="nb">cd</span><span class="w"> </span>snakemake_rnaseq/<span class="w">  </span><span class="c1"># Start developing in a new folder</span>
</code></pre></div>
<p>In this new folder, you should now see 2 subfolders:</p>
<ul>
<li><code>data/</code>, which contains the data to analyse</li>
<li><code>resources/</code>, which contains retrieved resources, here the assembly, the genome indices and the annotation file of <em>S. cerevisiae</em>. It may also contain small resources delivered along with the workflow via git</li>
</ul>
<p>Let&rsquo;s create another subfolder, this time to host all the files containing the code, as well as the Snakefile:</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>workflow<span class="w">  </span><span class="c1"># Create a new folder</span>
touch<span class="w"> </span>workflow/Snakefile<span class="w">  </span><span class="c1"># Create an empty Snakefile</span>
</code></pre></div>
<p>The Snakefile marks the entrypoint of the workflow. It will be automatically discovered when running Snakemake from the root of the structure, here <code>snakemake_rnaseq/</code>. We can also tell Snakemake to use a specific Snakefile with the <code>-s</code> flag: <code>snakemake --cores 1 -s &lt;Snakefile_path&gt; &lt;target&gt;</code>, but it is highly discouraged as it hampers reproducibility.</p>
<p>If you followed the <a href="#general-instructions-and-reminders">general instructions</a>, Snakemake should create all the other missing folders by itself (except one that you will discover at the end of this series of exercises), so it is now time to create the rules mentioned <a href="#exercises">earlier</a>. Have a look <a href="#designing-a-workflow">here</a> for a few pieces of advice on workflow design.</p>
<div class="admonition note">
<p class="admonition-title">&lsquo;bottom-up&rsquo; or &lsquo;top-down&rsquo; development?</p>
<p>Even if it is often easier to start from the final outputs and work backwards to the first inputs, the next exercises are presented in the opposite direction (first inputs to last outputs) to make the session easier to understand. That being said, feel free to work and develop your code in the order you prefer!</p>
</div>
<p><strong>Even if we asked you to use wildards, do not try to process all the samples yet. Choose and work with one sample (which means two .fastq files because reads are paired-end) in this series of exercises. We will see an efficient way to process list of files in the next series of exercises.</strong></p>
<h3 id="creating-a-rule-to-trim-reads">Creating a rule to trim reads</h3>
<p>Usually, the first step in dealing with sequencing data is to improve the reads quality by removing low quality bases, stretches of As and Ns and reads that are too short.</p>
<div class="admonition note">
<p class="admonition-title">Adapters trimming</p>
<p>In theory, trimming also removes sequencing adapters, but we will not do it here to keep computation time low and avoid having to parse other files to extract the adapter sequences.</p>
</div>
<p><strong>Exercise:</strong> Implement a rule to trim the reads contained in .fastq files using <a href="https://peerj.com/articles/3720/">atropos</a>.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<ul>
<li>You can find information on how to use atropos and its parameters with <code>atropos trim -h</code></li>
<li>The files to trim are located in <code>data/</code></li>
<li>The base of the trimming command is <code>atropos trim -q 20,20 --minimum-length 25 --trim-n --preserve-order --max-n 10 --no-cache-adapters -a "A{{20}}" -A "A{{20}}"</code><ul>
<li>If you are interested in what these options mean, see <a href="#atropos-options">below</a> for an explanation</li>
</ul>
</li>
<li>The paths of the files to trim (<em>i.e.</em> input files, in FASTQ format) are specified with the options <code>-pe1</code> (first read) and <code>-pe2</code> (second read)</li>
<li>The paths of the trimmed files (<em>i.e.</em> output files, also in FASTQ format) are specified with the options <code>-o</code> (first read) and <code>-p</code> (second read)</li>
<li>atropos outputs some information as well as its trimming report in the terminal (stdout to be exact); do not forget to redirect these information to the log file with <code>&gt;&gt; {log}</code></li>
</ul>
</div>
<p>Please give it a try before looking at the answer!</p>
<details class="done">
<summary>Answer</summary>
<p>This is one way of writing this rule, but definitely not the only way! This is true for all the rules presented here.</p>
<div class="highlight"><pre><span></span><code><span class="n">rule</span> <span class="n">fastq_trim</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This rule trims paired-end reads to improve their quality. Specifically, it removes:</span>
<span class="sd">    - Low quality bases</span>
<span class="sd">    - A stretches longer than 20 bases</span>
<span class="sd">    - N stretches</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="n">reads1</span> <span class="o">=</span> <span class="s1">&#39;data/</span><span class="si">{sample}</span><span class="s1">_1.fastq&#39;</span><span class="p">,</span>
        <span class="n">reads2</span> <span class="o">=</span> <span class="s1">&#39;data/</span><span class="si">{sample}</span><span class="s1">_2.fastq&#39;</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="n">trim1</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_atropos_trimmed_1.fastq&#39;</span><span class="p">,</span>
        <span class="n">trim2</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_atropos_trimmed_2.fastq&#39;</span>
    <span class="n">log</span><span class="p">:</span>
        <span class="s1">&#39;logs/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_atropos_trimming.log&#39;</span>
    <span class="n">benchmark</span><span class="p">:</span>
        <span class="s1">&#39;benchmarks/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_atropos_trimming.txt&#39;</span>
    <span class="n">resources</span><span class="p">:</span>
        <span class="n">mem_mb</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">shell</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        echo &quot;Trimming reads in &lt;{input.reads1}&gt; and &lt;{input.reads2}&gt;&quot; &gt; {log}</span>
<span class="sd">        atropos trim -q 20,20 --minimum-length 25 --trim-n --preserve-order --max-n 10 \</span>
<span class="sd">        --no-cache-adapters -a &quot;A{{20}}&quot; -A &quot;A{{20}}&quot; \</span>
<span class="sd">        -pe1 {input.reads1} -pe2 {input.reads2} -o {output.trim1} -p {output.trim2} &amp;&gt;&gt; {log}</span>
<span class="sd">        echo &quot;Trimmed files saved in &lt;{output.trim1}&gt; and &lt;{output.trim2}&gt; respectively&quot; &gt;&gt; {log}</span>
<span class="sd">        echo &quot;Trimming report saved in &lt;{log}&gt;&quot; &gt;&gt; {log}</span>
<span class="sd">        &#39;&#39;&#39;</span>
</code></pre></div>
<p>Note the three things that are happening here:</p>
<ol>
<li>We used the <code>{sample}</code> wildcards twice in the output paths. This is because we prefer to have all the files linked to a sample in the same directory</li>
<li>We added a memory limit for this job: 500 MB. Because we have limited resources in this server compared to a High Performance Computing cluster (HPC), this will help Snakemake to better allocate resources and parallelise jobs. You can determine the maximum amount of memory used by a rule thanks to the max_rss column in a benchmark result (results are shown in MB). More information <a href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#benchmark-rules">here</a></li>
<li>We used a backslash <code>\</code> to split a very long line in smaller lines. This is purely &lsquo;cosmetic&rsquo;, to avoid very long lines that are painful to read, copy&hellip;</li>
</ol>
</details>
<div class="admonition warning">
<p class="admonition-title">Paths in Snakemake</p>
<p>All the paths in the Snakefile are relative to the working directory in which the <code>snakemake</code> command is executed.</p>
<ul>
<li>If you execute Snakemake in <code>snakemake_rnaseq/</code>, the relative path to the input files in the rule is <code>data/&lt;sample&gt;.fastq</code></li>
<li>If you execute Snakemake in <code>snakemake_rnaseq/workflow/</code>, the relative path to the input files in the rule is <code>../data/&lt;sample&gt;.fastq</code></li>
</ul>
</div>
<p><strong>Exercise:</strong> If you had to run the workflow by specifying only one output, what command would you use?</p>
<details class="done">
<summary>Answer</summary>
<p><code>snakemake --cores 1 -r -p results/highCO2_sample1/highCO2_sample1_atropos_trimmed_1.fastq</code></p>
<p>If you run it now, don&rsquo;t forget to have a look at the log and benchmark files!</p>
</details>
<h4 id="atropos-options">atropos options</h4>
<ul>
<li><code>-q 20,20</code>: trim low-quality bases from 5&rsquo;, 3&rsquo; ends of each read before adapter removal</li>
<li><code>--minimum-length 25</code>: discard trimmed reads that are shorter than 25 bp</li>
<li><code>--trim-n</code>: trim N&rsquo;s on ends of reads</li>
<li><code>--preserve-order</code>: preserve order of reads in input files</li>
<li><code>--max-n 10</code>: discard reads with more than 10 N</li>
<li><code>--no-cache-adapters</code>: do not cache adapters list as &lsquo;.adapters&rsquo; in the working directory</li>
<li><code>-a "A{{20}}" -A "A{{20}}"</code>: remove series of 20 As in the adapter sequence (<code>-a</code> for the first read of the pair, <code>-A</code> for the second one)<ul>
<li>The usual command-line syntax is <code>-a "A{20}"</code>. Here, brackets were doubled to prevent Snakemake from interpreting <code>{20}</code> as a wildcard</li>
</ul>
</li>
</ul>
<h3 id="creating-a-rule-to-map-trimmed-reads-on-a-reference-genome">Creating a rule to map trimmed reads on a reference genome</h3>
<p>Once we have trimmed reads, the next step is to map those reads onto a reference assembly, here <em>S. cerevisiae</em> strain S288C, to eventually obtain read counts. The assembly used in this exercise is <a href="https://www.ncbi.nlm.nih.gov/datasets/genome/GCF_000146045.2/">RefSeq GCF_000146045.2</a> and was retrieved via the NCBI genome website.</p>
<p><strong>Exercise:</strong> Implement a rule to map the trimmed reads on the <em>S. cerevisiae</em> assembly using <a href="https://www.nature.com/articles/s41587-019-0201-4">HISAT2</a>.</p>
<div class="admonition note">
<p class="admonition-title">HISAT2 genome index</p>
<p>To align reads to a genome, HISAT2 relies on a graph-based index. We built the genome index for you, using the command <code>hisat2-build -p 24 -f Scerevisiae.fasta resources/genome_indices/Scerevisiae_index</code>.
<br><code>-p</code> is the number of threads to use, <code>-f</code> is the genomic sequence in <a href="https://en.wikipedia.org/wiki/FASTA_format">FASTA format</a> and <code>Scerevisiae_index</code> is the global name shared by all the index files.</p>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<ul>
<li>You can find information on how to use HISAT2 and its parameters with <code>hisat2 -h</code></li>
<li>The base of the mapping command is <code>hisat2 --dta --fr --no-mixed --no-discordant --time --new-summary --no-unal</code><ul>
<li>If you are interested in what these options mean, see <a href="#hisat2-options">below</a> for an explanation</li>
</ul>
</li>
<li>The path of the genome indices (<em>i.e.</em> input files, in binary format) is specified with the option <code>-x</code>. The files have a shared title of <code>resources/genome_indices/Scerevisiae_index</code>, which is the value you need to use for <code>-x</code></li>
<li>The paths of the trimmed files (<em>i.e.</em> input files) are specified with the options <code>-1</code> (first read) and <code>-2</code> (second read)</li>
<li>The path of the mapped reads file (<em>i.e.</em> output file, in SAM format) is specified with the option <code>-S</code> (do not forget the .sam extension to the filename)</li>
<li>The path of the mapping report (<em>i.e.</em> output file, in text format) is specified with the option <code>--summary-file</code></li>
<li>HISAT2 also outputs information in the terminal (stderr to be exact); do not forget to redirect these to the log file with <code>2&gt;&gt; {log}</code></li>
<li>This step is the longest of the workflow. With the current settings, it should take ~6 min to complete. If you decide to run it now, you should launch it and start working on the next rules</li>
</ul>
</div>
<p>Please give it a try before looking at the answer!</p>
<details class="done">
<summary>Answer</summary>
<div class="highlight"><pre><span></span><code><span class="n">rule</span> <span class="n">read_mapping</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This rule maps trimmed reads of a fastq on a reference assembly.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="n">trim1</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">fastq_trim</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">trim1</span><span class="p">,</span>
        <span class="n">trim2</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">fastq_trim</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">trim2</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="n">sam</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapped_reads.sam&#39;</span><span class="p">,</span>
        <span class="n">report</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapping_report.txt&#39;</span>
    <span class="n">log</span><span class="p">:</span>
        <span class="s1">&#39;logs/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapping.log&#39;</span>
    <span class="n">benchmark</span><span class="p">:</span>
        <span class="s1">&#39;benchmarks/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapping.txt&#39;</span>
    <span class="n">resources</span><span class="p">:</span>
        <span class="n">mem_gb</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">shell</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        echo &quot;Mapping the reads&quot; &gt; {log}</span>
<span class="sd">        hisat2 --dta --fr --no-mixed --no-discordant --time --new-summary --no-unal \</span>
<span class="sd">        -x resources/genome_indices/Scerevisiae_index \</span>
<span class="sd">        -1 {input.trim1} -2 {input.trim2} -S {output.sam} --summary-file {output.report} 2&gt;&gt; {log}</span>
<span class="sd">        echo &quot;Mapped reads saved in &lt;{output.sam}&gt;&quot; &gt;&gt; {log}</span>
<span class="sd">        echo &quot;Mapping report saved in &lt;{output.report}&gt;&quot; &gt;&gt; {log}</span>
<span class="sd">        &#39;&#39;&#39;</span>
</code></pre></div>
</details>
<p><strong>Exercise:</strong> If you had to run the workflow by specifying only one output, what command would you use?</p>
<details class="done">
<summary>Answer</summary>
<p><code>snakemake --cores 1 -r -p results/highCO2_sample1/highCO2_sample1_mapped_reads.sam</code></p>
<p>If you run it now, don&rsquo;t forget to have a look at the log and benchmark files!</p>
</details>
<h4 id="hisat2-options">HISAT2 options</h4>
<ul>
<li><code>--dta</code>: report alignments tailored for transcript assemblers</li>
<li><code>--fr</code>: set alignment of -1, -2 mates to forward/reverse (position of reads in a pair relatively to each other)</li>
<li><code>--no-mixed</code>: remove unpaired alignments for paired reads</li>
<li><code>--no-discordant</code>: remove discordant alignments for paired reads</li>
<li><code>--time</code>: print wall-clock time taken by search phases</li>
<li><code>--new-summary</code>: print alignment summary in a new style</li>
<li><code>--no-unal</code>: suppress SAM records for reads that failed to align</li>
</ul>
<h3 id="creating-a-rule-to-convert-and-sort-sam-files-to-bam">Creating a rule to convert and sort SAM files to BAM</h3>
<p>HISAT2 only outputs mapped reads in the <a href="https://en.wikipedia.org/wiki/SAM_(file_format)">SAM format</a>. However, most downstream analysis tools use the <a href="https://en.wikipedia.org/wiki/Binary_Alignment_Map">BAM format</a>, which is the compressed binary version of the SAM format and, as such, is much smaller, easier to manipulate and transfer and allows a faster data retrieval. Additionally, many analyses require that BAM files are sorted by genomic coordinates and indexed, because sorted BAM files can be processed much more easily and quickly than unsorted ones.</p>
<div class="admonition note">
<p class="admonition-title">Alignment data files</p>
<p>More information on alignment data files and other formats on the <a href="https://github.com/samtools/hts-specs">official github repository</a> of the formats.</p>
</div>
<p><strong>Exercise:</strong> Implement a <strong>single</strong> rule to:</p>
<ol>
<li>Convert SAM files to BAM using <a href="https://doi.org/10.1093/gigascience/giab008">Samtools</a></li>
<li>Sort the BAM files using Samtools</li>
<li>Index the sorted BAM files using Samtools</li>
</ol>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<ul>
<li>You can find information on how to use Samtools and its parameters with <code>samtools --help</code></li>
<li>You need to write 3 commands that will be executed sequentially: the output of command 1 will be the input of command 2 etc&hellip;<ul>
<li>No panic! These commands are pretty simple and do not use many options!</li>
</ul>
</li>
<li>To convert SAM format to the BAM format, use the command <code>samtools view &lt;input_file&gt; -b -o &lt;output_file&gt;</code></li>
<li>To sort a BAM file, use the command <code>samtools sort &lt;input_file&gt; -O bam -o &lt;output_file&gt;</code></li>
<li>To index a BAM file, use the command <code>samtools index -b &lt;input_file&gt; -o &lt;output_file&gt;</code><ul>
<li>The index must have the exact same name than its associated BAM file, except it finishes with the extension <code>.bam.bai</code> instead of <code>.bam</code></li>
</ul>
</li>
<li>If you are interested in what these options mean, see <a href="#samtools-options">below</a> for an explanation</li>
<li>To catch potential information and errors, do not forget to redirect <code>stderr</code> to the log file with <code>2&gt;&gt; {log}</code></li>
</ul>
</div>
<p>Please give it a try before looking at the answer!</p>
<details class="done">
<summary>Answer</summary>
<div class="highlight"><pre><span></span><code><span class="n">rule</span> <span class="n">sam_to_bam</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This rule converts a sam file to bam format, sorts it and indexes it.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="n">sam</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">read_mapping</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">sam</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="n">bam</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapped_reads.bam&#39;</span><span class="p">,</span>
        <span class="n">bam_sorted</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapped_reads_sorted.bam&#39;</span><span class="p">,</span>
        <span class="n">index</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapped_reads_sorted.bam.bai&#39;</span>
    <span class="n">log</span><span class="p">:</span>
        <span class="s1">&#39;logs/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapping_sam_to_bam.log&#39;</span>
    <span class="n">benchmark</span><span class="p">:</span>
        <span class="s1">&#39;benchmarks/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_mapping_sam_to_bam.txt&#39;</span>
    <span class="n">resources</span><span class="p">:</span>
        <span class="n">mem_mb</span> <span class="o">=</span> <span class="mi">250</span>
    <span class="n">shell</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        echo &quot;Converting &lt;{input.sam}&gt; to BAM format&quot; &gt; {log}</span>
<span class="sd">        samtools view {input.sam} -b -o {output.bam} 2&gt;&gt; {log}</span>
<span class="sd">        echo &quot;Sorting BAM file&quot; &gt;&gt; {log}</span>
<span class="sd">        samtools sort {output.bam} -O bam -o {output.bam_sorted} 2&gt;&gt; {log}</span>
<span class="sd">        echo &quot;Indexing the sorted BAM file&quot; &gt;&gt; {log}</span>
<span class="sd">        samtools index -b {output.bam_sorted} -o {output.index} 2&gt;&gt; {log}</span>
<span class="sd">        echo &quot;Sorted file saved in &lt;{output.bam_sorted}&gt;&quot; &gt;&gt; {log}</span>
<span class="sd">        &#39;&#39;&#39;</span>
</code></pre></div>
</details>
<p><strong>Exercise:</strong> If you had to run the workflow by specifying only one output, what command would you use?</p>
<details class="done">
<summary>Answer</summary>
<p><code>snakemake --cores 1 -r -p results/highCO2_sample1/highCO2_sample1_mapped_reads_sorted.bam</code></p>
<p>If you run it now, don&rsquo;t forget to have a look at the log and benchmark files!</p>
</details>
<h4 id="samtools-options">Samtools options</h4>
<ul>
<li>samtools view<ul>
<li><code>-b</code>: flag to tell Samtools to create an output in BAM format</li>
<li><code>-o</code>: path of the output file</li>
</ul>
</li>
<li>samtools view<ul>
<li><code>-O bam</code>: flag to tell Samtools to create an output in BAM format</li>
<li><code>-o</code>: path of the output file</li>
</ul>
</li>
<li>samtools index<ul>
<li><code>-b</code>: flag to tell Samtools to create an index in BAI format</li>
</ul>
</li>
</ul>
<h3 id="creating-a-rule-to-count-mapped-reads">Creating a rule to count mapped reads</h3>
<p>Most of the analyses happening downstream the alignment step, including Differential Expression Analyses, are starting off read counts, either by exon or gene. However, we are still missing those counts!</p>
<div class="admonition note">
<p class="admonition-title">Counting reads on exons/genes</p>
<p>To count reads mapping on genomic features, we first need a definition of those features. In this case, we picked one of the best-known model organism, <em>S. cerevisiae</em>, which has been annotated for a long time. These annotations are easily available on the <a href="https://www.ncbi.nlm.nih.gov/datasets/genome/GCF_000146045.2/">NCBI</a> or the <a href="https://www.yeastgenome.org/">Saccharomyces Genome Database</a>. If your organism has not been annotated yet, there are ways to work around this problem, but this is an entirely different field that we won&rsquo;t discuss here!</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Chromosome names</p>
<p>If you are working with genome sequences and annotations from different sources, remember that they <strong>must</strong> contain the chromosome names, otherwise counting will not work.</p>
</div>
<p><strong>Exercise:</strong> Implement a rule to count the reads mapping on each gene of the <em>S. cerevisiae</em> genome using <a href="https://academic.oup.com/bioinformatics/article/30/7/923/232889">featureCounts</a>.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<ul>
<li>You can find information on how to use featureCounts and its parameters with <code>featureCounts -h</code></li>
<li>The base of the mapping command is <code>featureCounts -t exon -g gene_id -s 2 -p -B -C --largestOverlap --verbose -F GTF</code><ul>
<li>If you are interested in what these options mean, see <a href="#featurecounts-options">below</a> for an explanation</li>
</ul>
</li>
<li>The path of the file containing the annotations (<em>i.e.</em> input files, in GTF format) is specified with the <code>-a</code> option. This file is located at <code>resources/Scerevisiae.gtf</code><ul>
<li>There are two main annotations format: <a href="http://mblab.wustl.edu/GTF2.html">GTF</a> and <a href="https://github.com/The-Sequence-Ontology/Specifications/blob/master/gff3.md">GFF</a>. The former is lighter and easier to work with, so that is the one we will use</li>
</ul>
</li>
<li>The paths of the sorted BAM file(s) (<em>i.e.</em> input file(s)) are not specified with an option, they are simply added at the end of the command</li>
<li>The path of the file containing the count results (<em>i.e.</em> output file, in tsv format) is specified with the option <code>-o</code><ul>
<li>featureCounts will also output a separate file (in tsv format) including summary statistics of counting results, with the name <code>&lt;output_name&gt;</code>.summary. For example, if the output is <code>test.tsv</code>, the summary will be printed in <code>test.tsv.summary</code>. Do not forget this output in your rule</li>
</ul>
</li>
<li>featureCounts also outputs information in the terminal (stderr to be exact); do not forget to redirect these to the log file with <code>2&gt;&gt; {log}</code></li>
</ul>
</div>
<p>Please give it a try before looking at the answer!</p>
<details class="done">
<summary>Answer</summary>
<div class="highlight"><pre><span></span><code><span class="n">rule</span> <span class="n">reads_quantification_genes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This rule quantifies the reads of a bam file mapping on genes and produces</span>
<span class="sd">    a count table for all genes of the assembly.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="n">bam_once_sorted</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">sam_to_bam</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">bam_sorted</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="n">gene_level</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_genes_read_quantification.tsv&#39;</span><span class="p">,</span>
        <span class="n">gene_summary</span> <span class="o">=</span> <span class="s1">&#39;results/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_genes_read_quantification.summary&#39;</span>
    <span class="n">log</span><span class="p">:</span>
        <span class="s1">&#39;logs/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_genes_read_quantification.log&#39;</span>
    <span class="n">benchmark</span><span class="p">:</span>
        <span class="s1">&#39;benchmarks/</span><span class="si">{sample}</span><span class="s1">/</span><span class="si">{sample}</span><span class="s1">_genes_read_quantification.txt&#39;</span>
    <span class="n">resources</span><span class="p">:</span>
        <span class="n">mem_mb</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">shell</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        echo &quot;Counting reads mapping on genes in &lt;{input.bam_once_sorted}&gt;&quot; &gt; {log}</span>
<span class="sd">        featureCounts -t exon -g gene_id -s 2 -p -B -C --largestOverlap --verbose -F GTF \</span>
<span class="sd">        -a resources/Scerevisiae.gtf -o {output.gene_level} {input.bam_once_sorted} &amp;&gt;&gt; {log}</span>
<span class="sd">        echo &quot;Renaming output files&quot; &gt;&gt; {log}</span>
<span class="sd">        mv {output.gene_level}.summary {output.gene_summary}</span>
<span class="sd">        echo &quot;Results saved in &lt;{output.gene_level}&gt;&quot; &gt;&gt; {log}</span>
<span class="sd">        echo &quot;Report saved in &lt;{output.gene_summary}&gt;&quot; &gt;&gt; {log}</span>
<span class="sd">        &#39;&#39;&#39;</span>
</code></pre></div>
</details>
<h4 id="featurecounts-options">featureCounts options</h4>
<ul>
<li><code>-t</code>: specify on which feature type to count the reads</li>
<li><code>-g</code>: specify if and how to gather feature counts. Here, reads are counted by exon (<code>-t</code>) and the exon counts are gathered by genes &lsquo;meta-features’ (<code>-g</code>)</li>
<li><code>-s</code>: perform strand-specific read counting<ul>
<li>Strandedness is determined by looking at the mRNA library preparation kit. It can also be determined <em>a posteriori</em> with scripts such as <a href="https://rseqc.sourceforge.net/#infer-experiment-py">infer_experiment.py</a> from the <a href="http://doi.org/10.1093/bioinformatics/bts356">RSeQC package</a></li>
</ul>
</li>
<li><code>-p</code>: count fragments instead of reads.<ul>
<li>If you don&rsquo;t use this option with paired-end reads, featureCounts won&rsquo;t be able to assign the read-pairs to features</li>
</ul>
</li>
<li><code>-B</code>: only count read pairs that have both ends aligned</li>
<li><code>-C</code>: do not count read pairs that have their two ends mapping to different chromosomes or mapping on the same chromosome but on different strands</li>
<li><code>--largestOverlap</code>: assign reads to the meta-feature/feature that has the largest number of overlapping bases</li>
<li><code>-F</code>: specify format of the provided annotation file</li>
<li><code>--verbose</code>: output verbose information, such as unmatched chromosome/contig names</li>
</ul>
<h3 id="running-the-workflow">Running the workflow</h3>
<p><strong>Exercise:</strong> If you have not done it after each step, it is now time to run the entire workflow on your sample of choice. What command will you use to run it?</p>
<details class="done">
<summary>Answer</summary>
<p>Because all the rules are chained together, you only need to specify one of the final outputs to trigger the execution of all the previous rules:</p>
<p><code>snakemake --cores 1 -F -r -p results/highCO2_sample1/highCO2_sample1_genes_read_quantification.tsv</code>.</p>
<p>You can add the <code>-F</code> flag to force an entire re-run. The entire run should take about ~10 min to complete.</p>
</details>
<p><strong>Exercise:</strong> Check Snakemake&rsquo;s log in <code>.snakemake/log/</code>. Is everything as you expected, especially the wildcard values, input and output names etc&hellip;?</p>
<details class="done">
<summary>Answer</summary>
<p><code>cat .snakemake/log/&lt;latest_log&gt;</code></p>
</details>
<h3 id="visualising-the-dag-of-the-workflow">Visualising the DAG of the workflow</h3>
<p>We have now implemented and run the main steps of our workflow. It is always a good idea to visualise the whole process to check for errors and inconsistencies. Snakemake&rsquo;s has a built-in workflow visualisation feature to do this.</p>
<p><strong>Exercise:</strong> Visualise the entire workflow’s Directed Acyclic Graph using the <code>--dag</code> flag. Do you need to specify a target?</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<ul>
<li>Try to follow the official recommendations on workflow structure, which states that images are supposed to go in the <code>images/</code> subfolder</li>
<li>Snakemake prints a DAG in text format, so we need to use the <code>dot</code> command to transform it into a picture</li>
<li>Save the result as a PNG picture</li>
</ul>
</div>
<details class="done">
<summary>Answer</summary>
<p>If we run the command without target: <code>snakemake --cores 1 --dag -F | dot -Tpng &gt; images/dag.png</code>, we will get a <code>Target rules may not contain wildcards.</code> error, which means we need to add a target. Same as before, it makes sense to use one of the final outputs to get the entire workflow: <code>snakemake --cores 1 --dag -F results/highCO2_sample1/highCO2_sample1_genes_read_quantification.tsv | dot -Tpng &gt; images/dag.png</code>.</p>
<p>But once again, we will get an error: <code>BrokenPipeError: [Errno 32] Broken pipe</code>. This is because we are piping the command output to a folder (<code>images/</code>) that does not exist yet The folder is not created by Snakemake because it isn&rsquo;t handled as part of an actual run. So we have to create the folder before generating the DAG:</p>
<div class="highlight"><pre><span></span><code>mkdir images
snakemake --cores 1 --dag -F results/highCO2_sample1/highCO2_sample1_genes_read_quantification.tsv | dot -Tpng &gt; images/dag.png
</code></pre></div>
<p>Some explanations on the command:</p>
<ul>
<li><code>-F</code>: force to show the entire worklow and ensures all jobs are shown. You can also use <code>-f &lt;target&gt;</code> to show fewer jobs</li>
<li><a href="https://graphviz.org/docs/layouts/dot/"><code>dot</code></a>: tool that is a part of the <a href="https://graphviz.org/">graphviz package</a> and is used to draw hierarchical or layered drawings of directed graphs, <em>i.e.</em> graphs in which edges (arrows) have a direction</li>
<li><code>-T</code>: control the image format. Available formats are listed <a href="https://graphviz.org/docs/outputs/">here</a></li>
</ul>
</details>
<div class="admonition note">
<p class="admonition-title">DAG aspect</p>
<p>If you already computed all the outputs of the workflow, steps in the DAG will have dotted lines. To visualise the DAG before running the workflow, add <code>-F/--forceall</code> to the snakemake command to force the execution of all jobs.</p>
</div>
<div class="admonition note">
<p class="admonition-title">DAG = dry-run</p>
<p>The <code>--dag</code> flag implicitly activates the <code>--dry-run/--dryrun/-n</code> option, which means that no jobs are executed during the plot creation.</p>
</div>
<p>There are actually 3 types of DAG:</p>
<ul>
<li>A DAG, created with the <code>--dag</code> option</li>
<li>A filegraph, created with the <code>--filegraph</code> option</li>
<li>A rulegraph, created with the <code>--rulegraph</code> option</li>
</ul>
<p><strong>Exercise:</strong> Generate the filegraph and rulegraph of your workflow. Feel free to try different pictures format. What are the differences between the plots?</p>
<details class="done">
<summary>Answer</summary>
<ul>
<li>Generate the rulegraph: <code>snakemake --cores 1 --rulegraph -F results/highCO2_sample1/highCO2_sample1_genes_read_quantification.tsv | dot -Tpdf &gt; images/rulegraph.pdf</code></li>
<li>Generate the filegraph: <code>snakemake --cores 1 --filegraph -F results/highCO2_sample1/highCO2_sample1_genes_read_quantification.tsv | dot -Tjpg &gt; images/filegraph.jpg</code></li>
</ul>
</details>
<p>You should obtain the 3 following figures:</p>
<figure>
  <img src="../../../assets/images/backbone_dag.png" width="30%" height="450" align="center"/>
  <img src="../../../assets/images/backbone_rulegraph.png" width="30%" height="450" align="center"/>
  <img src="../../../assets/images/backbone_filegraph.png" width="30%" height="450" align="center"/>
  <figcaption>DAG, rulegraph and filegraph (respectively) of the workflow<br>at the end of the session</figcaption>
</figure>

<p>The differences between these plots are:</p>
<ul>
<li><code>--dag</code>: dependency graph of all the jobs</li>
<li><code>--filegraph</code>: dependency graph of rules with inputs and outputs (rule appears once, with wildcards)</li>
<li><code>--rulegraph</code>: dependency graph of rules (rule appears once)</li>
</ul>
<h3 id="designing-a-snakemake-workflow-and-debugging-it">Designing a Snakemake workflow&hellip; and debugging it!</h3>
<h4 id="designing-a-workflow">Designing a workflow</h4>
<p>There are many ways to design a new workflow, but these few pieces of advice will be useful in most cases:</p>
<ul>
<li>Start with a pen and paper: try to find out how many rules you will need and how they depend on each other. In other terms, start by sketching the DAG of your workflow!<ul>
<li>Remember that Snakemake has a bottom-up approach (it goes from the final outputs to the first input), so it may be easier for you to work in that order as well and write your last rule first</li>
<li>Determine which rules (if any) aggregate or split inputs and create input functions accordingly (we will see how these functions work in session 4)</li>
</ul>
</li>
<li>Make sure your input and output directives are right before worrying about anything else, especially the shell sections.<ul>
<li>Remember that Snakemake builds the DAG before running the shell commands, so you can use the <code>--dryrun</code> option to test the workflow before running it. You can even do that without writing all the shell commands!</li>
</ul>
</li>
<li>List any parameters or settings that might need to be adjusted</li>
<li>Choose meaningful and easy-to-understand names for your inputs, outputs, parameters, wildcards&hellip; to make your Snakefile as readable as possible. This is true for every script, piece of code, variable etc&hellip; and Snakemake is no exception! Have a look at <a href="https://peps.python.org/pep-0020/">The Zen of Python</a> for more information</li>
</ul>
<h4 id="debugging-a-workflow">Debugging a workflow</h4>
<p>It is very likely you will see bugs and errors the first time you try to run a new Snakefile: don’t be discouraged, this is normal!</p>
<p><strong>Order of operations in Snakemake</strong></p>
<p>The topic was tackled when DAGs were mentioned, but to efficiently debug a workflow, it is worth taking a deeper look at what Snakemake does when you execute the command <code>snakemake --cores 1 &lt;target&gt;</code>. There are 3 main phases:</p>
<ol>
<li>Prepare to run:<ol>
<li>Read all the rule definitions from the Snakefile</li>
</ol>
</li>
<li>Resolve the DAG (when Snakemake says ‘Building DAG of jobs’):<ol>
<li>Check what output(s) are required</li>
<li>Look for a matching rule by looking at the outputs of all the rules</li>
<li>Fill in the wildcards to determine the input of the matching rule</li>
<li>Check whether this input is available; if not, repeat Step 2 until everything is resolved</li>
</ol>
</li>
<li>Run:<ol>
<li>If needed, create the folder for the output(s)</li>
<li>If needed, remove the outdated output(s)</li>
<li>Run the shell command with the placeholders replaced</li>
<li>Check that the command ran without errors and produced the expected output(s)</li>
</ol>
</li>
</ol>
<p><strong>Debugging advice</strong></p>
<p>Sometimes, Snakemake will give you a precise error report, but other times less so. Try to identify which phase of execution failed (see previous paragraph on order of operations) and double-check the most common error causes for that phase:</p>
<ol>
<li>Parsing phase failures (phase 1):<ul>
<li>Syntax errors, among which (but not limited to):<ul>
<li><em>This errors can be easily solved using a text editor with Python/Snakemake text colouring</em></li>
<li>Missing commas/colons/semicolons</li>
<li>Unbalanced quotes/brackets/parenthesis</li>
<li>Wrong indentation</li>
</ul>
</li>
<li>Failure to evaluate expressions<ul>
<li>Problems in functions (<code>expand()</code>, input functions&hellip;) in input/output directives</li>
<li>Python logic added outside of rules</li>
</ul>
</li>
<li>Other problems with rule definition<ul>
<li>Invalid rule names/directives</li>
<li>Invalid wildcard names</li>
<li>Mismatched wildcards</li>
</ul>
</li>
</ul>
</li>
<li>DAG building failures (phase 2, before Snakemake tries to run any job):<ul>
<li>Failure to determine the target</li>
<li>Ambiguous rules making the same output(s)</li>
<li>On the contrary, no rule making the required output(s)</li>
<li>Circular dependency (violating the &lsquo;Acyclic&rsquo; property of a D<strong>A</strong>G).</li>
<li>Write-protected output(s)</li>
</ul>
</li>
<li>DAG running failures (phase 3, <code>--dry-run</code> works and builds the DAG, but the real execution fails):<ul>
<li><em>When a job fails, Snakemake reports an error, deletes all output file(s) for that job (potential corruption), and stops</em></li>
<li>Shell command returning non-zero status</li>
<li>Missing output file(s) after the commands have run</li>
<li>Reference to a <code>$shell_variable</code> before it was set</li>
<li>Use of a wrong/unknown placeholder inside <code>{ }</code></li>
</ul>
</li>
</ol>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-2023 SIB Swiss institute of Bioinformatics - <a href="#__consent">Change cookie settings</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["announce.dismiss"], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.aecac24b.min.js"></script>
      
    
  </body>
</html>